name: LaTeX Compilation

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  compile:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check out the repository
      uses: actions/checkout@v2

    - name: Set up LaTeX
      run: sudo apt-get install -y texlive-latex-base texlive-latex-extra texlive-fonts-recommended texlive-fonts-extra

    - name: Find the .tex file and its directory
      run: |
        # Troviamo la cartella principale contenente il file .tex
        export TEX_DIR=$(find . -type f -name "*.tex" -exec dirname {} \; | head -n 1)
        export TEX_FILE=$(find $TEX_DIR -name "*.tex" | head -n 1)

        echo "TEX_DIR=${TEX_DIR}" >> $GITHUB_ENV
        echo "TEX_FILE=${TEX_FILE}" >> $GITHUB_ENV

        echo "File trovato: $TEX_FILE nella cartella $TEX_DIR"

    - name: Create output PDF directory
      run: |
        # Creiamo la directory per il PDF se non esiste
        OUTPUT_DIR="PDF/$(basename $TEX_DIR)"
        mkdir -p $OUTPUT_DIR
        echo "La directory per il PDF sar√†: $OUTPUT_DIR"

    - name: Compile LaTeX file
      run: |
        # Compilazione del file .tex
        pdflatex -shell-escape -interaction=nonstopmode -file-line-error $TEX_FILE
        pdflatex -shell-escape -interaction=nonstopmode -file-line-error $TEX_FILE  # Secondo run per risolvere i riferimenti

    - name: Move PDF to the correct output directory
      run: |
        # Spostiamo il PDF generato nella cartella PDF/analisi_dei_requisiti
        OUTPUT_DIR="PDF/$(basename $TEX_DIR)"
        mv *.pdf $OUTPUT_DIR/
        echo "PDF spostato in: $OUTPUT_DIR"
      
    - name: Upload PDF
      uses: actions/upload-artifact@v3
      with:
        name: output-pdf
        path: $TEX_DIR/*.pdf
