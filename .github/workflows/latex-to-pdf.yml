name: Build PDF

on:
  workflow_dispatch:  # Permette di avviare manualmente il workflow con un file .tex come input
    inputs:
      tex_file:
        description: "Nome del file .tex senza estensione (esempio: 2024-12-10)"
        required: true
        default: "2024-12-10"

  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  PDF_FOLDER: "PDF"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install TeX Live with Italian support
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive texlive-latex-extra texlive-fonts-recommended texlive-lang-italian

      - name: Install Inkscape
        run: sudo apt-get install -y inkscape

      - name: Convert SVG to PDF
        run: |
          FILE_NAME=${{ github.event.inputs.tex_file }}
          inkscape $FILE_NAME/images/pebkac.svg --export-filename=$FILE_NAME/images/pebkac.pdf
          inkscape $FILE_NAME/images/logo_unipd.svg --export-filename=$FILE_NAME/images/logo_unipd.pdf

      - name: Compile LaTeX to PDF
        run: |
          FILE_NAME=${{ github.event.inputs.tex_file }}
          cd $FILE_NAME
          latexmk -pdf -shell-escape -interaction=nonstopmode $FILE_NAME.tex

      - name: Create PDF folder structure and move PDF
        run: |
          FILE_NAME=${{ github.event.inputs.tex_file }}
          mkdir -p ${{ env.PDF_FOLDER }}/$FILE_NAME
          mv $FILE_NAME/$FILE_NAME.pdf ${{ env.PDF_FOLDER }}/$FILE_NAME/

      - name: Commit and push PDF to main
        run: |
          FILE_NAME=${{ github.event.inputs.tex_file }}
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ env.PDF_FOLDER }}/
          git commit -m "Add PDF output for $FILE_NAME"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdf
          path: ${{ env.PDF_FOLDER }}/${{ github.event.inputs.tex_file }}/${{ github.event.inputs.tex_file }}.pdf
