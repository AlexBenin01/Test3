name: LaTeX and PDF Workflow

on:
  push:
    branches:
      - develop
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Cache TeX Live installation
      - name: Cache TeX Live
        uses: actions/cache@v3
        with:
          path: /usr/local/texlive
          key: ${{ runner.os }}-texlive
          restore-keys: |
            ${{ runner.os }}-texlive

      # Install TeX Live with Italian support (minimal installation)
      - name: Install minimal TeX Live with Italian support
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-base texlive-lang-italian
          sudo tlmgr install xcolor geometry

      # Install Inkscape (using parallel installation to speed up)
      - name: Parallel installation of TeX Live and Inkscape
        run: |
          sudo apt-get install -y inkscape &
          wait

      # Compile LaTeX files
      - name: Compile LaTeX
        run: |
          mkdir -p PDF
          for dir in $(find src/2 - RTB -type d); do
            if [ -f "$dir"/*.tex ]; then
              pdflatex -output-directory=PDF "$dir"/*.tex
            fi
          done

      # Archive PDFs as artifact
      - name: Upload PDFs as artifact
        uses: actions/upload-artifact@v3
        with:
          name: PDFs
          path: PDF

  transport_to_main:
    needs: build
    runs-on: ubuntu-latest

    steps:
      # Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Download artifacts from previous job
      - name: Download PDFs artifact
        uses: actions/download-artifact@v3
        with:
          name: PDFs

      # Move PDFs to the correct structure
      - name: Restructure PDFs
        run: |
          for file in PDF/**/*.pdf; do
            base_name=$(basename "$file")
            dir_name=$(dirname "$file" | xargs basename)
            mv "$file" "PDF/$dir_name-$base_name"
          done

      # Push changes to main
      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Transport PDFs to main branch"
          git push origin main
